<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
  -->

  
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <title>GalagoMusic</title>
    
    <!-- jQuery -->
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>

    <script type="text/javascript">
    $(document).bind("mobileinit", function(){
    $.mobile.allowCrossDomainPages = true;
    $.mobile.support.cors = true;
    //$.mobile.defaultPageTransition='none';
    //$.mobile.defaultDialogTransition='none';
    $.mobile.buttonMarkup.hoverDelay=0;
    //$.mobile.ignoreContentEnabled="true";
    });
    </script>

    <script type="text/javascript" src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>

    <!-- Custom -->
    <script type="text/javascript" src="js/magicline.js"></script>
    <script type="text/javascript" src="js/cssToggle.js"></script>
    
    <!-- PhoneGap -->
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    
    <script type="text/javascript">
        
    document.addEventListener("deviceready",onDeviceReady,false);
    var dataJSON;
    var dataJSONPaying;
    var db = null;
    
    function onDeviceReady() 
    {    
        db = window.openDatabase("GalagoFavs", "1.0", "GalagoFavs", 200000);
        db.transaction(createDB,errorDB,successDB);
        getJSONData();
    }
    
    function createDB(tx)
    {
        //tx.executeSql("DROP TABLE IF EXISTS GalagoFavs");
        tx.executeSql("CREATE TABLE IF NOT EXISTS GalagoFavs (id unique)");
    }
    
    function successDB()
    {
    }
    
    function errorDB(tx,err)
    {
        alert("Database creation failed ("+err+")");
    }
    
    function getJSONData()
    {
        //
        // Ajax request
        //
        
        $url = "http://www.galagomusic.com/JSON/json_get_data.php?user=GalagoTeam&password=GalaTeam";
        $.getJSON($url, function(data) 
                           {
                           dataJSON = data;
                           populatePages();
                           displayPages();
                           });
        
        $url_paying = "http://www.galagomusic.com/JSON/json_get_paying_data.php?user=GalagoTeam&password=GalaTeam";
        $.getJSON($url_paying, function(data) 
                           {
                           dataJSONPaying = data;
                           populateDonate();
                           });
    }
    
    function populatePages() {
        for (var i = 0; i < dataJSON.length; ++i)
        {
            addNewItem(i);
        }
        
        if (db !== null)
        {
            db.transaction(function(tx){
               checkFavorites(tx); 
            });
        }
    }
    
    function addNewItem(index)
    {
        if (index < dataJSON.length)
        {
        var newItem = $("<table class='itemCours "+dataJSON[index].ID+"' index='"+index+"'>\
                                <tr class='itemCoursPreview'>\
                                    <td class='itemCoursTitleArtist'>\
                                        <span class='itemCoursTitle'>"+dataJSON[index].Title+"</span><br/>\
                                        <span class='itemCoursArtist'>"+dataJSON[index].Artist+"</span>\
                                    </td>\
                                    <td class='itemCoursDifficulty'>DIFFICULTY<br/>"+dataJSON[index].Difficulty+" / 10\
                                    </td>\
                                </tr>\
                                <tr class='coursProperties itemCoursWhiteLine'>\
                                    <td></td><td></td>\
                                </tr>\
                                <tr class='coursProperties'>\
                                    <td class='itemCoursDuration'><img src='img/icone-timer.png'></img><span> "+dataJSON[index].Duration+"</span></td>\
                                    <td class='itemCoursFavorite' rowspan='2'><span class='isNotFavorite'></span></td>\
                                </tr>\
                                <tr class='coursProperties'>\
                                    <td class='itemCoursGuitar'><span>"+dataJSON[index].Instrument+"</span></td>\
                                </tr>"+ (dataJSON[index].Tablature === "" ? "" : 
                                "<tr class='coursProperties'>\
                                    <td colspan='2' class='itemCoursTab'><a>Download Tablature</a></td>\
                                </tr>\
                                <tr class='coursProperties itemCoursSpacer'>\
                                    <td></td><td></td>\
                                </tr>") +
                                "<tr class='coursProperties'>\
                                    <td colspan='2' class='itemCoursWatch'><a>Watch Video</a></td>\
                                </tr>\
                                <tr class='coursProperties itemCoursSpacer'>\
                                    <td></td><td></td>\
                                </tr>\
                            </table>");
        
        $("#recentPage .pageContent").append($(newItem).clone());
        $("#difficultyPage .pageContent #diff"+dataJSON[index].Difficulty+" .difficultyCours").append($(newItem).clone());
        }
        
    }
   
    function checkFavorites(tx)
    {
        var sqlQuery = "SELECT * FROM GalagoFavs";
        tx.executeSql(sqlQuery,[],function(tx,results){
            var numberOfFavorites = results.rows.length;
            for (var i = 0; i < numberOfFavorites; ++i)
            {
                $(".pageContent ."+results.rows.item(i).id+" .itemCoursFavorite span").removeClass("isNotFavorite").addClass("isFavorite");
                $("#favoritePage .pageContent").append($("#recentPage .pageContent ."+results.rows.item(i).id).clone());
            }
        });
    }
    
    function favoriteError(tx,err)
    {
        alert("Couldn't add favorite ("+err+")");
    }
    
    function populateDonate()
    {           
        var supportText = $("<div style='padding:2px;margin-right:1%;margin-left:1%;'>\
			     <i><ins>Vous pouvez soutenir GalagoMusic de deux facons:</ins><br>\
                             <ol style='margin:1px;'>\
                                 <li>Participer au Galagothon</li>\
                                 <li>Acheter un cours GalagoMusic</li>\
                             </ol></i><br />\
			     <i><ins>You have two options to support GalagoMusic:</ins><br>\
                             <ol style='margin:1px;'>\
                                 <li>Participate to Galagothon</li>\
                                 <li>Buy a Galago course</li>\
                             </ol></i>\
			     </div>");

        var payingCourseTitle = $("<div id='payingCourses'><span class='donateTitle'>Cours Payants</span></div>");

        var paypalTitle = $("<div id='paypal'><span class='donateTitle'>Galagothon</span></div>");

        var galagothon = $('<div id="galagothon" class="one-half-last">\
		<p>Vous appréciez les cours, la méthode et la bonne humeur ? <br />Alors n\'hésitez pas à offrir un coup de pouce à Galagomusic en faisant un don, ceci permettra de perpétuer la qualité du travail proposé. <br />En vous remerciant d\'avance !<br />\
Musicalement, <br /><i>Eric Legaud</i>.</p>\
		<div style="float:left; width:100%; height: 151px; background-color:#b51f29; overflow:hidden; margin-top:5px;margin-bottom:10px;">\
			<p style="float: left; font-size: 17px; color: #fff; width: 100%; margin-top: 10px; text-align: center;">Participez à l\'aventure,</br><b>faites un don</b></br>en cliquant ci-dessous.</p>\
			<form style="width:200px; margin-left:auto;margin-right:auto;"action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">\
				<input type="hidden" name="cmd" value="_s-xclick">\
				<input type="hidden" name="hosted_button_id" value="XVDN2ARWSWEPA">\
				<input type="image" src="https://www.paypalobjects.com/fr_FR/FR/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - Solution de paiement en ligne la plus sécurisée !">\
			</form>\
		</div>\
	</div><br />');


        $("#donatePage .pageContent").append(supportText);
        $("#donatePage .pageContent").append(paypalTitle);
        $("#donatePage .pageContent").append(galagothon);
        $("#donatePage .pageContent").append(payingCourseTitle);

        for (var i = 0; i < dataJSONPaying.length; ++i)
        {
            insertNewPayingCourse(i);
        }
    }
    
    function insertNewPayingCourse(index)
    {
        if (index < dataJSONPaying.length)
        {
        var newItem = $("<table class='itemCours' id='"+dataJSONPaying[index].ID+"' index='"+index+"'>\
             <tr class='itemCoursPreview'>\
                 <td class='itemCoursTitleArtist'>\
                     <span class='itemCoursTitle'>"+dataJSONPaying[index].Title+"</span>\
                 </td>\
             </tr>\
             <tr class='coursProperties itemCoursWhiteLine'>\
                 <td></td><td></td>\
             </tr>\
             <tr class='coursProperties'>\
                 <td class='itemCoursDescription'>"+dataJSONPaying[index].Description+"</td>\
             </tr>\
             <tr class='coursProperties'>\
                 <td colspan='2' class='itemCoursWatchTrailer'><a>Watch Trailer</a></td>\
             </tr>\
             <tr class='coursProperties itemCoursSpacer'>\
                 <td></td><td></td>\
             </tr>\
             <tr class='coursProperties'>\
                 <td colspan='2' class='itemCoursBuy'><a>Buy</a></td>\
             </tr>\
             <tr class='coursProperties itemCoursSpacer'>\
                 <td></td><td></td>\
             </tr>\
         </table>");

         $("#donatePage .pageContent #payingCourses").append(newItem);
        }
    }
    
    // Display main page after loading data
    //
    function displayPages() 
    {
        $("body #splashScreen").fadeOut(10, function() {
      	$("body #mainApp").fadeIn(10);
      	});

    }  
    </script>

  
  <body>
    <!-- Splash Screen -->  
    <div id="splashScreen" data-role="none">
      <h1 id="title">GalagoMusic</h1><br/>
    </div>

    <!-- Main Application -->
    <div id="mainApp">
      <div id="pages">
          
        <!-- Recent Page -->  
        <div id="recentPage" class="current" data-role="page">
            
            <div data-role="header" data-position="fixed" data-id="header" data-theme="c">
                <div data-role="navbar">
                    <ul>
                        <li><a href="#recentPage" class="ui-btn-active ui-state-persist">Recent</a></li>
                        <li><a href="#difficultyPage">Difficulty</a></li>
                        <li><a href="#favoritePage">Favorite</a></li>
                        <li><a href="#donatePage">Donate</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="pageContent" data-role="content">
            </div>
            
        </div>
        
        <!-- Difficulty Page -->
        <div id="difficultyPage" data-role="page">
            
            <div data-role="header" data-position="fixed" data-id="header" data-theme="c">
                <div data-role="navbar">
                    <ul>
                        <li><a href="#recentPage">Recent</a></li>
                        <li><a href="#difficultyPage" class="ui-btn-active ui-state-persist">Difficulty</a></li>
                        <li><a href="#favoritePage">Favorite</a></li>
                        <li><a href="#donatePage">Donate</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="pageContent" data-role="content">
                <div id="diff1">
                    <span class="difficultyTab">Difficulty 1 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff2">
                    <span class="difficultyTab">Difficulty 2 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff3">
                    <span class="difficultyTab">Difficulty 3 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff4">
                    <span class="difficultyTab">Difficulty 4 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff5">
                    <span class="difficultyTab">Difficulty 5 / 10</span>
                    <div class="difficultyCours"></div> 
                </div>
                <div id="diff6">
                    <span class="difficultyTab">Difficulty 6 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff7">
                    <span class="difficultyTab">Difficulty 7 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff8">
                    <span class="difficultyTab">Difficulty 8 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff9">
                    <span class="difficultyTab">Difficulty 9 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
                <div id="diff10">
                    <span class="difficultyTab">Difficulty 10 / 10</span>
                    <div class="difficultyCours"></div>
                </div>
            </div>
            
        </div>
        
        <!-- Favorite Page -->
        <div id="favoritePage" data-role="page">
            
            <div data-role="header" data-position="fixed" data-id="header" data-theme="c">
                <div data-role="navbar">
                    <ul>
                        <li><a href="#recentPage">Recent</a></li>
                        <li><a href="#difficultyPage">Difficulty</a></li>
                        <li><a href="#favoritePage" class="ui-btn-active ui-state-persist">Favorite</a></li>
                        <li><a href="#donatePage">Donate</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="pageContent" data-role="content">
            </div>
            
        </div>
        
        <!-- Donate Page -->
        <div id="donatePage" data-role="page">
            
            <div data-role="header" data-position="fixed" data-id="header" data-theme="c">
                <div data-role="navbar">
                    <ul>
                        <li><a href="#recentPage">Recent</a></li>
                        <li><a href="#difficultyPage">Difficulty</a></li>
                        <li><a href="#favoritePage">Favorite</a></li>
                        <li><a href="#donatePage" class="ui-btn-active ui-state-persist">Donate</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="pageContent" data-role="content">
            </div>
            
        </div>
      </div>
    </div>

    <script type="text/javascript">
      app.initialize();
    </script>
    
    <script type="text/javascript">
        $(document).on('click',".pageContent .itemCours .itemCoursTitleArtist", function(){
           var parent = $(this).closest(".itemCours");
           $(parent).find(".coursProperties").fadeToggle();
        });
      
        $(document).on('click',".pageContent .itemCours .itemCoursTab",function(){
              var parent = $(this).closest(".itemCours");
              navigator.app.loadUrl(dataJSON[Number(parent.attr('index'))].Tablature,{openExternal:true});
          });
        
        $(document).on('click',".pageContent .itemCours .itemCoursWatch",function(){
            var parent = $(this).closest(".itemCours");
            navigator.app.loadUrl("http:"+dataJSON[Number(parent.attr('index'))].YouTube,{openExternal:true});
        });
        
        $(document).on('click',".pageContent .itemCours .isNotFavorite",function(){
            var parent = $(this).closest(".itemCours");
            var index = Number(parent.attr('index'));
            
            if (db !== null)
            {
                db.transaction(function(tx){
                    var sqlQuery = "INSERT INTO GalagoFavs (id) VALUES (?)";
                    tx.executeSql(sqlQuery,[dataJSON[index].ID],function(){
                            $(".pageContent ."+dataJSON[index].ID+" .isNotFavorite").removeClass("isNotFavorite").addClass("isFavorite");
                            var clonedItem = $(parent).clone();
                            clonedItem.find(".coursProperties").hide();
                            $("#favoritePage .pageContent").append($(clonedItem));     
                    });
                });
            }
        });
        
        $(document).on('click',".pageContent .itemCours .isFavorite",function(){
            var parent = $(this).closest(".itemCours");
            var index = Number(parent.attr('index'));
        
            if (db !== null)
            {
                db.transaction(function(tx){
                    var sqlQuery = "DELETE FROM GalagoFavs WHERE id=?";
                    tx.executeSql(sqlQuery,[dataJSON[index].ID],function(){                  
                            $(".pageContent ."+dataJSON[index].ID+" .isFavorite").removeClass("isFavorite").addClass("isNotFavorite");   
                            $("#favoritePage .pageContent ."+dataJSON[index].ID).remove();
                    });
                });
            }
        });

        $(document).on('click',".pageContent .itemCours .itemCoursBuy",function(){
            var parent = $(this).closest(".itemCours");
            navigator.app.loadUrl(dataJSONPaying[Number(parent.attr('index'))].Link,{openExternal:true});
        });
        
        $(document).on('click',".pageContent .itemCours .itemCoursWatchTrailer",function(){
            var parent = $(this).closest(".itemCours");
            navigator.app.loadUrl("http:"+dataJSONPaying[Number(parent.attr('index'))].YouTube,{openExternal:true});
        });
        
        $(document).on('click',".pageContent .difficultyTab",function(){
           var parent = $(this).closest("div");
           $(parent).find(".difficultyCours").fadeToggle();
        });
    </script>
    
  </body>

